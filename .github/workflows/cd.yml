name: CD - Deploy to GCP

on:
  push:
    branches: [main]
    paths:
      - 'DongHaeng_backend/**'
      - '.github/workflows/cd.yml'
  workflow_dispatch:  # ÏàòÎèô Ïã§Ìñâ Í∞ÄÎä•

jobs:
  deploy:
    name: Deploy to GCP
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./DongHaeng_backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker to use gcloud
        run: gcloud auth configure-docker asia-northeast3-docker.pkg.dev

      - name: Build and Push Docker image
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          IMAGE_NAME: dongheng-backend
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t asia-northeast3-docker.pkg.dev/$PROJECT_ID/dongheng/$IMAGE_NAME:$IMAGE_TAG .
          docker build -t asia-northeast3-docker.pkg.dev/$PROJECT_ID/dongheng/$IMAGE_NAME:latest .
          docker push asia-northeast3-docker.pkg.dev/$PROJECT_ID/dongheng/$IMAGE_NAME:$IMAGE_TAG
          docker push asia-northeast3-docker.pkg.dev/$PROJECT_ID/dongheng/$IMAGE_NAME:latest

      - name: Deploy to Compute Engine
        env:
          INSTANCE_NAME: ${{ secrets.GCP_INSTANCE_NAME }}
          ZONE: ${{ secrets.GCP_ZONE }}
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          gcloud compute ssh $INSTANCE_NAME --zone=$ZONE --command="
            docker pull asia-northeast3-docker.pkg.dev/$PROJECT_ID/dongheng/dongheng-backend:latest &&
            docker stop dongheng-backend || true &&
            docker rm dongheng-backend || true &&
            docker run -d \
              --name dongheng-backend \
              --restart unless-stopped \
              -p 3000:3000 \
              --env-file /home/dongheng/.env.production \
              asia-northeast3-docker.pkg.dev/$PROJECT_ID/dongheng/dongheng-backend:latest
          "

      - name: Health check
        env:
          INSTANCE_IP: ${{ secrets.GCP_INSTANCE_IP }}
        run: |
          sleep 30
          curl -f http://$INSTANCE_IP:3000/health || exit 1

      - name: Notify deployment
        if: success()
        run: echo "üöÄ Deployment successful!"

      - name: Rollback on failure
        if: failure()
        env:
          INSTANCE_NAME: ${{ secrets.GCP_INSTANCE_NAME }}
          ZONE: ${{ secrets.GCP_ZONE }}
        run: |
          echo "‚ùå Deployment failed. Rolling back..."
          gcloud compute ssh $INSTANCE_NAME --zone=$ZONE --command="
            docker stop dongheng-backend || true &&
            docker rm dongheng-backend || true &&
            docker run -d \
              --name dongheng-backend \
              --restart unless-stopped \
              -p 3000:3000 \
              --env-file /home/dongheng/.env.production \
              asia-northeast3-docker.pkg.dev/\$PROJECT_ID/dongheng/dongheng-backend:previous
          "
